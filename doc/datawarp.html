<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>
      Using DataWarp as Burst Buffers in PnetCDF
    </title>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-45938012-1', 'auto');
  ga('create', 'UA-45937491-1', 'auto', {'name': 'pnetcdfTracker'});
  ga('create', 'UA-46002884-1', 'auto', {'name': 'parallelnetcdfTracker'});
  ga('send', 'pageview');
  ga('pnetcdfTracker.send', 'pageview');
  ga('parallelnetcdfTracker.send', 'pageview');
</script>
  </head>
  <body>
<h2 id="ParallelnetCDF:AParallelIOLibraryforNetCDFFileAccess">Using DataWarp as Burst Buffers in PnetCDF</h2>
PnetCDF now implements a new I/O driver that uses 
  <a href="https://www.cray.com/datawarp">Cray's DataWarp</a> as burst buffers.
Through this driver, write requests are first stored in DataWarp and later flushed to the parallel file system at file close or explicitly flushed by users.
This new driver is still under development and has been tested on the <a href=http://www.nersc.gov/users/computational-systems/cori>Cori</a> parallel computer at 
  <a href="http://www.nersc.gov">NERSC</a>.
It will soon be merged to the official release.

<h3 id="OverviewofPnetCDF">Enable the DataWarp Driver</h3>
To build PnetCDF with DataWarp driver support, add &quot;<tt>--enable-datawarp</tt>&quot; option at the configure command line.
<pre>
    ./configure --prefix=/path/to/install --enable-datawarp
</pre>

<h3 id="ABriefBackgroundAboutNetCDF">Use DataWarp Driver</h3>
The use of DataWarp driver is controlled by PnetCDF I/O hints.
There are two ways of setting PnetCDF I/O hints.
<ul>
<li> One is by setting MPI file info object and passing it through the call to file create API
     <tt>
<a href="http://cucis.ece.northwestern.edu/projects/PnetCDF/doc/pnetcdf-c/ncmpi_005fcreate.html">ncmpi_create</a></tt> or file open API <tt>
<a href="http://cucis.ece.northwestern.edu/projects/PnetCDF/doc/pnetcdf-c/ncmpi_005fopen.html">ncmpi_open</a></tt>.</li>
<li> The other is by setting the environment variable <tt>PNETCDF_HINTS</tt>.</li>
</ul>
For instance, to enable the DataWarp driver, add 
  to the MPI-IO info object the hint &quot;nc_dw&quot;.</p>
<pre>
    MPI_Info_set(info, &quot;nc_dw&quot;, &quot;enable&quot;);
</pre>
The hint can also be set using environment variable PNETCDF_HINTS.</p>
<pre>
    export PNETCDF_HINTS=&quot;nc_dw=enable&quot;
</pre>
See more information on how to set PnetCDF hints through the environment variable in the <a href=http://cucis.eecs.northwestern.edu/projects/PnetCDF/doc/pnetcdf-c/PNETCDF_005fHINTS.html>PnetCDF C Interface Guide</a>.

<h3 id="ABriefHistoryofPnetCDF">PnetCDF Hints for Controlling DataWarp Driver</h3>
Below is a list of hints for controlling the behavior of the DataWarp driver.

<table style="width:100%", border="1">
<tr>
    <th>Hint Key</th>
    <th>Value</th> 
    <th>Default Value</th>
    <th>Description</th>
</tr>
<tr>
    <td>nc_dw</td>
    <td>enable or disable</td> 
    <td>disable</td>
    <td>Whether to enable DataWarp driver or not. The rest of the hints will be 
	ignored if DataWarp driver is disabled.</td>
</tr>
<tr>
    <td>nc_dw_dirname</td>
    <td>a directory name</td> 
    <td>current directory</td>
    <td>The location on DataWarp system to store I/O data. This is usually set to the value of variable DW_JOB_PRIVATE or DW_JOB_STRIPED, depending on the access_mode set in the batch script.
See the user guide of <a href=http://www.nersc.gov/users/computational-systems/cori/burst-buffer/example-batch-scripts>How to use the Burst Buffer</a> on Cori for picking the access mode.</td>
</tr>
<tr>
    <td>nc_dw_del_on_close</td>
    <td>enable or disable</td> 
    <td>enable</td>
    <td>Whether the files created by the DataWarp driver should be deleted after closing the NetCDF file.
When it is disabled, the <a href="https://slurm.schedmd.com">SLURM</a> scheduler may stage out the data automatically after the job is completed or keep the data, depending on the setting in the job script.
See section of 
	<a href="http://www.nersc.gov/users/computational-systems/cori/burst-buffer/example-batch-scripts/#toc-anchor-4">Persistent Reservations</a> in the Cori user guide for more information.</td>
  </tr>
<tr>
    <td>nc_dw_flush_buffer_size</td>
    <td>an integer in bytes</td> 
    <td>0</td>
    <td>Amount of memory in each MPI process that allows PnetCDF to use for flushing the data stored in DataWarp to the parallel file system.
0 means unlimited.
Note that any single write request that is larger than the buffer size will not be buffered.
Instead, it will be written to the parallel file system directly, bypassing the DataWarp 
	driver.</td>
  </tr>
</table>

<h3 id="ANoteAboutLargeFileSupport">Example Program</h3>
<pre>
    #include&lt;stdio.h&gt; 
    #include&lt;stdlib.h&gt;
    #include&lt;pnetcdf.h&gt;

    int main(int argc, char *argv[]){ 
        int ncid, err; 
        MPI_Info info; 

        MPI_Info_create(&amp;info); 

        /* Enable the DataWarp driver. 
        * The hint is not required if it is set in the environment variable PNETCDF_HINTS 
        */ 
        MPI_Info_set(info, &quot;nc_dw&quot;, &quot;enable&quot;); 

        /* Create a NetCDF file with hint to enable DataWarp driver*/ 
        ncmpi_create(MPI_COMM_WORLD, filename, NC_CLOBBER, info, &amp;ncid); 

        /* Use PnetCDF as usual */ 

        /* data stored in the burst buffer will be flushed to the PFS when the file is closed */ 
        mpi_close(ncid); 

        MPI_Info_free(&amp;info); 
        return 0 
    }
</pre>

<h3 id="Submitting Job">Example Job Script</h3>
Below is an example script for using DataWarp on Cori at NERSC.
For detailed information about DataWarp settings, users are referred to <a href=http://www.nersc.gov/users/computational-systems/cori/burst-buffer/example-batch-scripts>How to use the Burst Buffer on Cori</a>.
<pre>
    #!/bin/bash
    #SBATCH -p debug
    #SBATCH -N 1 
    #SBATCH -C haswell
    #SBATCH -t 00:10:00 
    #SBATCH -o output.txt 
    #DW jobdw capacity=1289GiB access_mode=private type=scratch pool=sm_pool 

    export PNETCDF_HINTS="nc_dw=enable;nc_dw_del_on_close=disable;nc_dw_dirname=${DW_JOB_PRIVATE}"

    srun -n 1 ./myapplication 
</pre>

<h3 id="ANoteAboutLargeFileSupport">Known Issues</h3>
While we design the DataWarp driver to be as transparent as possible,
there are some behaviors that can change when the DataWarp driver is used.
<ul>
<li>Error reporting: The error codes returned from write related APIs are the errors encountered when writing to the DataWarp system.
When flushing data from DataWarp to the parallel file system, the error code returned will be the first error encountered.
</li>
</ul>
<h3 id="FileandVariableLimits">Questions and Answers</h3>
<p>
Q: Can I run the DataWarp driver on a different machine with a different burst buffer configuration?
<br/>
A: We currently have only tested the DataWarp driver on Cori at NERSC and the Cray DataWarp system installed there.
It may also work on other burst buffer implementations where the burst buffer is mounted as a file system.
<p>
Q: Can I run the DataWarp driver without the burst buffer?<br/>
A: Yes, as long as the hint "nc_dw_dirname" is a valid directory, PnetCDF will use it as a burst buffer.
However, the performance will be affected depending on the performance of the devices.
<p>
<hr>
Please email your questions to &lt;<a href="mailto:parallel-netcdf@lists.mcs.anl.gov">parallel-netcdf@lists.mcs.anl.gov</a>&gt;
<p>
</body>
</html>
