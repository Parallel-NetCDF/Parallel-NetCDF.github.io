<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>
      Using DataWarp as Burst Buffers in PnetCDF
    </title>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-45938012-1', 'auto');
  ga('create', 'UA-45937491-1', 'auto', {'name': 'pnetcdfTracker'});
  ga('create', 'UA-46002884-1', 'auto', {'name': 'parallelnetcdfTracker'});
  ga('send', 'pageview');
  ga('pnetcdfTracker.send', 'pageview');
  ga('parallelnetcdfTracker.send', 'pageview');
</script>
  </head>
  <body>
<h1 id="ParallelnetCDF:AParallelIOLibraryforNetCDFFileAccess">Using DataWarp as Burst Buffers in PnetCDF</h1>
	  <p>DataWarp driver is a I/O driver in PnetCDF that implements a log-based I/O aggregation for write related I/O requests that is designed to work on Cray DataWarp.</p>
	  <h2 id="OverviewofPnetCDF">Building PnetCDF with DataWarp Driver</h2>
<p>
	To build PnetCDF with DataWarp driver support, simply set &quot;--enable-datawarp&quot; option at configure time:</p>

<figure>
  <pre>
 <code style="font-family: &quot;Courier New&quot;">
./configure --prefix=/path/to/install --enable-datawarp
</code>
</pre>
</figure>
	  <h2 id="ABriefBackgroundAboutNetCDF">Running with DataWarp Driver</h2>
	  <p>The DataWarp driver is enable by setting file hints on file creation/opening. To enable DataWarp driver, set the hint &quot;nc_dw&quot; to enable.</p>
	  <figure>
  <pre>
<code style="font-family: &quot;Courier New&quot;">
MPI_Info_set(info, &quot;nc_dw&quot;, &quot;enable&quot;);
</code>
</pre>
</figure>
	  
	  <p>The hint can also be set using environment variable PNETCDF_HINTS.</p>
<figure>
  <pre>
 <code style="font-family: &quot;Courier New&quot;">
export PNETCDF_HINTS=&quot;nc_dw=enable&quot;
</code>
</pre>
</figure>

<h2 id="ABriefHistoryofPnetCDF">Supported Hints</h2>
<p>
	The DataWarp can be configured using hints. Here&#39;s a list of supported hints:</p>

	  <table style="width:100%", border="1">
  <tr>
    <th>Hint</th>
    <th>Values</th> 
    <th>Default</th>
	<th>Description</th>
  </tr>
  <tr>
    <td>nc_dw</td>
    <td>enable/disable</td> 
    <td>disable</td>
	<td>Whether DataWarp driver is enabled.</td>
  </tr>
  <tr>
    <td>nc_dw_dirname</td>
    <td>&lt;Valid POSIX Directory&gt;</td> 
    <td>&lt;Current Working Directory&gt;</td>
	<td>Where (directory) should log file be placed. This is usually set to the path where burst buffer is mounted.</td>
  </tr>
		    <tr>
    <td>nc_dw_del_on_close</td>
    <td>enable/disable</td> 
    <td>enable</td>
	<td>Whether logfile should be deleted after closing the NetCDF file. It can be disabled when the scheduler will clean up the burst buffer automatically after the job is completed.</td>
  </tr>
		    <tr>
    <td>nc_dw_flush_buffer_size</td>
    <td>&lt;integer&gt;</td> 
    <td>0</td>
	<td>Amount of memory that can be used to flush the log. The unit is in bytes. 0 means unlimited. Any write request that is larger than the buffer size will not be buffered, instead, it will be written to PFS directly.</td>
  </tr>
		    <tr>
    <td>nc_dw_shared_log</td>
    <td>enable/disable</td> 
    <td>disable</td>
	<td>When enabled, processes within a node will share the same log file. It is recommended when the burst buffer is set to striped mode. By default, each process will create it&#39;s own log file</td>
  </tr>
</table>

<h2 id="ANoteAboutLargeFileSupport">Example Program</h2>
<figure>
  <pre>
 <code style="font-family: &quot;Courier New&quot;">
#include&lt;stdio.h&gt; 
#include&lt;stdlib.h&gt;
#include&lt;pnetcdf.h&gt;
int main(int argc, char *argv[]){ 
&nbsp int ncid; 
&nbsp MPI_Info info; 
&nbsp MPI_Info_create(&amp;info); 
&nbsp /* Enable the DataWarp driver. 
&nbsp  * The hint is not required if it is set in the enviroment variable PNETCDF_HINTS 
&nbsp  */ 
&nbsp MPI_Info_set(info, &quot;nc_dw&quot;, &quot;enable&quot;); 
&nbsp /* Create new netcdf file with hint to enable DataWarp driver*/ 
&nbsp ncmpi_create(MPI_COMM_WORLD, filename, NC_CLOBBER, info, &amp;ncid); 
&nbsp /* Use PnetCDF as usual */ 
&nbsp /* The data in the burst buffer will be flushed to the PFS when the file is closed */ 
&nbsp mpi_close(ncid); 
&nbsp MPI_Info_free(&amp;info); 
&nbsp return 0 
}   </code>  </pre>
</figure>
	<h2 id="Submitting Job">Submitting Job that Enables DataWarp Driver</h2>
	  <p>We show an example script for enabling DataWarp driver on Cori at NERSC</p>

<figure>
  <pre>
 <code style="font-family: &quot;Courier New&quot;">
#!/bin/bash
#SBATCH -p debug
#SBATCH -N 1 
#SBATCH -C haswell
#SBATCH -t 00:10:00 
#SBATCH -o output.txt 
#DW jobdw capacity=1289GiB access_mode=private type=scratch pool=sm_pool 
export PNETCDF_HINTS="nc_dw=enable;nc_dw_del_on_close=disable;nc_dw_dirname=${DW_JOB_PRIVATE}"
srun -n 1 ./myapplication 
</code>  </pre>
</figure>

<h2 id="ANoteAboutLargeFileSupport">Known Problems</h2>
	  <p>While we design the DataWarp driver to be as transparent as possible. There are some behaviors that can change when the DataWarp driver is used. Here&#39;s a list of different behaviors:</p>
	<ul>
		<li>Log buffering delays actual file write to replay time. If there are errors caused by put operations, it will be hide by logging until the log is replayed.</li>
	</ul>
<h2 id="FileandVariableLimits">FAQ</h2>
<p>
	Q: Can I run the DataWarp driver on other burst buffer implementation or architecture?
	<br/>
	A: It is only tested on Cray DataWarp. However, it should, in theory, also work on other burst buffer implementations where the burst buffer is mounted as a file system. </p>
	  <p>
	Q: Can I run the DataWarp driver without the burst buffer?<br/>
		  A: Yes, as long as there is place for log files. However, the performance will be affected if the log is placed on a slow file system. </p>
</body>
</html>
