<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>
      Parallel Netcdf
    </title>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-45938012-1', 'auto');
  ga('create', 'UA-45937491-1', 'auto', {'name': 'pnetcdfTracker'});
  ga('create', 'UA-46002884-1', 'auto', {'name': 'parallelnetcdfTracker'});
  ga('send', 'pageview');
  ga('pnetcdfTracker.send', 'pageview');
  ga('parallelnetcdfTracker.send', 'pageview');
</script>
  </head>
  <body>
<h1 id="ParallelnetCDF:AParallelIOLibraryforNetCDFFileAccess">Datawarp Driver Open Beta</h1>
<h2 id="News">What is Datawarp Driver</h2>
	  <p>Datawarp driver is a IO driver in PnetCDF that implements a log-based IO aggregation for write related IO requests that is designed to wotk on Cray DataWarp.</p>
	  <h2 id="OverviewofPnetCDF">Building PnetCDF with Datawarp Driver</h2>
<p>
	To build PnetCDF with Datawarp driver support, simply set &quot;--enable-dwdriver&quot; option at configure time:</p>
<p>

	./configure --prefix=/path/to/install --enable-dwdriver
</p>
	  <h2 id="ABriefBackgroundAboutNetCDF">Running with Datawarp Driver</h2>
	  <p>The datawarp driver is enable by setting file hints on file creation/opening. To enable datawarp driver, set the hint &quot;nc_dw_driver&quot; to enable.</p>
	  <p>MPI_Info_set(info, &quot;nc_dw_driver&quot;, &quot;enable&quot;);</p>
	  <p>The hint can also be set using environment variable PNETCDF_HINTS.</p>
	  <p>
		  export PNETCDF_HINTS=&quot;nc_dw_driver=enable&quot;</p>
<h2 id="ABriefHistoryofPnetCDF">Supported Hints</h2>
<p>
	The datawarp can be configured using hints. Here&#39;s a list of supported hints:</p>

	  <table style="width:100%">
  <tr>
    <th>Hint</th>
    <th>Values</th> 
    <th>Default</th>
	<th>Description</th>
  </tr>
  <tr>
    <td>nc_dw_driver</td>
    <td>enable/disable</td> 
    <td>disable</td>
	<td>Whether datawarp driver is enabled.</td>
  </tr>
  <tr>
    <td>nc_dw_dirname</td>
    <td>&lt;Valid POSIX Directory&gt;</td> 
    <td>&lt;Current Working Directory&gt;</td>
	<td>Where (directory) should log file be placed. This is usually set to the path where burst buffer is mounted.</td>
  </tr>
		    <tr>
    <td>nc_dw_del_on_close</td>
    <td>enable/disable</td> 
    <td>enable</td>
	<td>Whether logfile should be deleted after closing the NetCDF file. It can be disabled when the schedular will clean up the burst ubffer automatically after the job is completed.</td>
  </tr>
		    <tr>
    <td>nc_dw_flush_buffer_size</td>
    <td>&lt;integer&gt;</td> 
    <td>0</td>
	<td>Amount of memory that can be used to flush the log. The unit is in bytes. 0 means unlimited. Any write request that is larger than the buffer size will not be buffered, instead, it will be written to PFS directly.</td>
  </tr>
		    <tr>
    <td>nc_dw_sharedlog</td>
    <td>enable/disable</td> 
    <td>disable</td>
	<td>When enabled, processes within a node will share the same log file. It is recommended when the bursst buffer is set to striped mode. By default, each process will create it&#39;s own log file</td>
  </tr>
</table>

<h2 id="ANoteAboutLargeFileSupport">Example Program</h2>
	  <p>#include&lt;stdio.h&gt; <br/>
		  #include&lt;stdlib.h&gt;<br/>
		  #include&lt;pnetcdf.h&gt;<br/>
		  <br/>
		  int main(int argc, char *argv[]){<br/> 
		  &nbsp int ncid; <br/>
		  &nbsp MPI_Info info; <br/>
		  &nbsp MPI_Info_create(&amp;info); <br/>
		  &nbsp /* Enable the datawarp driver. <br/>
		  &nbsp * The hint is not required if it is set in the enviroment variable PNETCDF_HINTS <br/>
		  &nbsp */ <br/>
		  &nbsp MPI_Info_set(info, &quot;nc_dw_driver&quot;, &quot;enable&quot;); <br/>
		  &nbsp /* Create new netcdf file with hint to enable datawarp driver*/ <br/>
		  &nbsp ncmpi_create(MPI_COMM_WORLD, filename, NC_CLOBBER, info, &amp;ncid); <br/>
		  &nbsp /* Use PnetCDF as usual */ <br/>
		  &nbsp /* The data in the burst buffer will be flushed to the PFS when the file is closed */ <br/>
		  &nbsp cmpi_close(ncid); <br/>
		  &nbsp MPI_Info_free(&amp;info); <br/>
		  &nbsp return 0 <br/>
		  }
</p>
	<h2 id="Submitting Job">Submitting Job that Enables Datawarp Driver</h2>
	  <p>We show an example script for enabling datawarp driver on Cori at NERSC</p>
<p>
#!/bin/bash <br/>
#SBATCH -p debug <br/>
#SBATCH -N 1  <br/>
#SBATCH -C haswell <br/>
#SBATCH -t 00:10:00 <br/>
#SBATCH -o output.txt <br/>
#DW jobdw capacity=1289GiB access_mode=private type=scratch pool=sm_pool <br/>
export PNETCDF_HINTS="nc_dw_driver=enable;nc_dw_del_on_close=disable;nc_dw_dirname=${DW_JOB_PRIVATE}" <br/>
srun -n 1 ./myapplication <br/>
</p>

<h2 id="ANoteAboutLargeFileSupport">Known Problems</h2>
	  <p>While we design the datawarp driver to be as transparant as possible. There are some behaviors that can change when the datawarp driver is used. Here&#39;s a list of different behaviors:</p>
	<ul>
		<li>Log buffering delays actuall file write to replay time. If there are errors caused by put operations, it will be hided by logging until the log is replayed.</li>
	</ul>
<h2 id="FileandVariableLimits">FAQ</h2>
<p>
	Q: Can I run the datawarp driver on other burst buffer implementation or architecture?
	<br/>
	A: It is only tested on Cray DataWarp. Hoever, it should, in theory, also work on other burst buffer implementations where the burst buffer is mounted as a file system
	.</p>
	  <p>
	Q: Can I run the datawarp driver without the burst buffer?<br/>
		  A: Yes, as long as there is palce for log files. However, the performance will be affected if the log is placed on a slow file system. </p>
</body>
</html>
